<?php

namespace App\Repositories;

use App\Helpers\Helper;
use App\Http\Resources\EvenementResource;
use App\IRepository\IEvenementRepository;
use App\Models\Evenement;
use Carbon\Carbon;
use Illuminate\Support\Facades\Cache;

class EvenementRepository extends Repository implements IEvenementRepository
{
    /**
     * @param $model
     */
    public function __construct(Evenement $evenement)
    {
        parent::__construct($evenement);
    }

    /**
     * @param array $input
     * @return mixed
     */
    function create(array $input)
    {
        $input['eventdate']=Carbon::parse($input['eventdate'])->format('Y-m-d H:i:s');
        $input['imageheight']=Helper::extractHeight($input['affiche']);
        $input['imagewidth']=Helper::extractWidth($input['affiche']);
        return parent::create($input); // TODO: Change the autogenerated stub
    }

    /**
     * @param $id
     * @return mixed
     */
    function delete($id)
    {
        return parent::delete($id); // TODO: Change the autogenerated stub
    }

    /**
     * @param $id
     * @return mixed
     */
    function findById($id)
    {
        return parent::findById($id); // TODO: Change the autogenerated stub
    }

    /**
     * @param array $input
     * @param $id
     * @return mixed
     */
    function update(array $input, $id)
    {
        $currentEvent=$this->findById($id);
        $input['eventdate']=isset($input['eventdate'])?
            Carbon::parse($input['eventdate'])->format('Y-m-d H:i:s'):$currentEvent->eventdate;
        $input['affiche']= $input['affiche'] ?? $currentEvent->affiche;
        $input['imageheight']=Helper::extractHeight($input['affiche']);
        $input['imagewidth']=Helper::extractWidth($input['affiche']);
        return parent::update($input, $id); // TODO: Change the autogenerated stub
    }

    /**
     * @return mixed
     */
    function index()
    {
        return Evenement::orderByDesc('eventdate')->where('eventdate','>=',now())->get();
    }

    /**
     * @return mixed
     */
    function getCachedEvenements()
    {
        $events= Cache::remember('evenement', now()->add(1,'day'), function () {
            return Evenement::orderByDesc('eventdate')->where('eventdate','>=',now())->get();
        });
        return new EvenementResource($events->random()) ;
    }
}
